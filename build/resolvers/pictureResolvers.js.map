{"version":3,"sources":["../../src/resolvers/pictureResolvers.js"],"names":["uploader","AuthenticationError","Mutation","uploadProfileImage","parent","base64str","models","userModel","pictureModel","userInfo","info","alwreadyExist","find","author","_id","data","deleteObject","key","deleteMany","e","console","log","message","Error","upload","pictureRes","create","updateOne","profile_image_url","catch","user","findOne","exec"],"mappings":"AAAA,SAAQA,QAAR,QAAuB,mBAAvB;AACA,SAAQC,mBAAR,QAAkC,uBAAlC;;AAEA,eAAe;;AAEXC,cAAU;AACNC,4BAAoB,OAAOC,MAAP,EAAe,EAACC,SAAD,EAAf,EAA4B,EAACC,QAAQ,EAACC,SAAD,EAAYC,YAAZ,EAAT,EAAoCC,QAApC,EAA5B,EAA2EC,IAA3E,KAAoF;AACpG,gBAAI,CAACD,QAAL,EAAe;AACX,sBAAM,IAAIR,mBAAJ,CAAwB,2BAAxB,CAAN;AACH;AACD,kBAAMU,gBAAgB,MAAMH,aAAaI,IAAb,CAAkB,EAACC,QAAQJ,SAASK,GAAlB,EAAlB,CAA5B;AACA,gBAAIH,aAAJ,EAAmB;AACf;AACA,oBAAII,OAAO,MAAMf,SAASgB,YAAT,CAAsBL,cAAcM,GAApC,EAAyC,eAAzC,CAAjB;AACA,oBAAIF,IAAJ,EAAU;AACN,wBAAI;AACA,8BAAMP,aAAaI,IAAb,CAAkB,EAACC,QAAQJ,SAASK,GAAlB,EAAlB,EAA0CI,UAA1C,EAAN;AACH,qBAFD,CAEE,OAAOC,CAAP,EAAU;AACRC,gCAAQC,GAAR,CAAYF,EAAEG,OAAd;AACA,8BAAM,IAAIC,KAAJ,CAAU,sBAAV,CAAN;AACH;AACJ;AACJ;;AAED,gBAAIR,OAAO,MAAMf,SAASwB,MAAT,CAAgBnB,SAAhB,EAA2B,eAA3B,CAAjB;AACA,gBAAIU,IAAJ,EAAU;AACN,sBAAMU,aAAa,MAAMjB,aAAakB,MAAb,CAAoB,EAACT,KAAKF,KAAKE,GAAX,EAAgBJ,QAAQJ,SAASK,GAAjC,EAApB,CAAzB;AACA,sBAAMP,UAAUoB,SAAV,CAAoB,EAACb,KAAKW,WAAWZ,MAAjB,EAApB,EAA8C,EAACe,mBAAmBH,WAAWX,GAA/B,EAA9C,EACDe,KADC,CACMV,CAAD,IAAO;AACV,0BAAM,IAAII,KAAJ,CAAUJ,EAAEG,OAAZ,CAAN;AACH,iBAHC,CAAN;AAIA,oBAAIQ,OAAO,MAAMvB,UAAUwB,OAAV,CAAkB,EAACjB,KAAKL,SAASK,GAAf,EAAlB,EAAuCkB,IAAvC,EAAjB;AACAZ,wBAAQC,GAAR,CAAYS,IAAZ;AACA,uBAAO,EAAC,OAAOf,KAAKE,GAAb,EAAP;AACH;AACJ;AA9BK;AAFC,CAAf","file":"pictureResolvers.js","sourcesContent":["import {uploader} from \"../utils/AwsS3.js\"\nimport {AuthenticationError} from \"apollo-server-express\";\n\nexport default {\n\n    Mutation: {\n        uploadProfileImage: async (parent, {base64str}, {models: {userModel, pictureModel}, userInfo}, info) => {\n            if (!userInfo) {\n                throw new AuthenticationError('You are not authenticated');\n            }\n            const alwreadyExist = await pictureModel.find({author: userInfo._id})\n            if (alwreadyExist) {\n                //delete From bucket\n                let data = await uploader.deleteObject(alwreadyExist.key, 'users/avatars')\n                if (data) {\n                    try {\n                        await pictureModel.find({author: userInfo._id}).deleteMany();\n                    } catch (e) {\n                        console.log(e.message)\n                        throw new Error('Error Update Profile')\n                    }\n                }\n            }\n\n            let data = await uploader.upload(base64str, 'users/avatars')\n            if (data) {\n                const pictureRes = await pictureModel.create({key: data.key, author: userInfo._id});\n                await userModel.updateOne({_id: pictureRes.author}, {profile_image_url: pictureRes._id})\n                    .catch((e) => {\n                        throw new Error(e.message)\n                    })\n                let user = await userModel.findOne({_id: userInfo._id}).exec()\n                console.log(user)\n                return {'key': data.key}\n            }\n        }\n    }\n};"]}